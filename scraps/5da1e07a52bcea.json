{
  "title": "WSL2 の gcc 13.3.0 で ruby 3.4.4 コンパイル",
  "closed": false,
  "archived": false,
  "created_at": "2025-05-24",
  "comments": [
    {
      "author": "oooooooo",
      "created_at": "2025-05-24",
      "body_markdown": "## TLDR\n\n- gcc 13.3.0 で mise install ruby 3.4.4 のコンパイルが失敗する。最適化をやめることで解決\n- gcc 14.2.0 ならコンパイル成功\n\n## 環境\n\nWSL2 の Ubuntu 24.04\n\n```shell\n$ uname -a\nLinux Windows11 5.15.167.4-microsoft-standard-WSL2 #1 SMP Tue Nov 5 00:21:55 UTC 2024 x86_64 x86_64 x86_64 GNU/Linux\n\n$ cat /etc/lsb-release\nDISTRIB_ID=Ubuntu\nDISTRIB_RELEASE=24.04\nDISTRIB_CODENAME=noble\nDISTRIB_DESCRIPTION=\"Ubuntu 24.04.2 LTS\"\n\n$ gcc --version\ngcc (Ubuntu 13.3.0-6ubuntu2~24.04) 13.3.0\n```\n\n## エラー内容\n\nSegmentation fault で落ちる場所はばらばら。過去、コンパイルできた 3.4.2, 3.4.3 もコンパイル失敗する。\n\n```shell\n$ MISE_JOBS=28 mise install ruby 3.4.4\nINFO  ruby@3.4.4      compiling vm_dump.c\nINFO  ruby@3.4.4      compiling vm_sync.c\nduring GIMPLE pass: threadfull\nrational.c: In function ‘rb_gcdlcm’:\nrational.c:1953:1: internal compiler error: Segmentation fault\n 1953 | rb_gcdlcm(VALUE self, VALUE other)\n      | ^~~~~~~~~\n0x108d8f4 internal_error(char const*, ...)\n        ???:0\n0x12a2ac4 bitmap_copy(bitmap_head*, bitmap_head const*)\n        ???:0\n0x13aced4 path_range_query::compute_ranges(bitmap_head const*)\n        ???:0\n0x13b9f00 back_threader::find_taken_edge_cond(vec<basic_block_def*, va_heap, vl_ptr> const&, gcond*)\n        ???:0\n0x13a7c80 back_threader::maybe_register_path(back_threader_profitability&)\n        ???:0\n0x13a1161 back_threader::find_paths_to_names(basic_block_def*, bitmap_head*, unsigned int, back_threader_profitability&)\n        ???:0\n0x13a1546 back_threader::find_paths_to_names(basic_block_def*, bitmap_head*, unsigned int, back_threader_profitability&)\n        ???:0\n0x139ffa6 back_threader::maybe_thread_block(basic_block_def*)\n        ???:0\n0x136c451 back_threader::thread_blocks()\n        ???:0\nPlease submit a full bug report, with preprocessed source (by using -freport-bug).\nPlease include the complete backtrace with any bug report.\nSee <file:///usr/share/doc/gcc-13/README.Bugs> for instructions.\nmake: *** [Makefile:463: rational.o] Error 1\nmake: *** Waiting for unfinished jobs....\nduring RTL pass: bbpart\nIn file included from compile.c:14733:\nprism_compile.c: In function ‘pm_static_literal_value’:\nprism_compile.c:830:1: internal compiler error: Segmentation fault\n  830 | }\n      | ^\n0x108d8f4 internal_error(char const*, ...)\n        ???:0\n0x12a2ac4 bitmap_copy(bitmap_head*, bitmap_head const*)\n        ???:0\n0x149002b run_fast_df_dce()\n        ???:0\n0x141e49b df_analyze_problem(dataflow*, bitmap_head*, int*, int)\n        ???:0\nPlease submit a full bug report, with preprocessed source (by using -freport-bug).\nPlease include the complete backtrace with any bug report.\nSee <file:///usr/share/doc/gcc-13/README.Bugs> for instructions.\nmake: *** [Makefile:462: compile.o] Error 1\nINFO  ruby@3.4.4      external command failed with status 2\nBUILD FAILED (Ubuntu 24.04 on x86_64 using ruby-build 20250516)\nYou can inspect the build directory at /tmp/ruby-build.20250524174059.29769.igifpG\nERROR ~/.cache/mise/ruby/ruby-build/bin/ruby-build failed\nError:\n   0: failed to install core:ruby@3.4.4\n   1: ~/.cache/mise/ruby/ruby-build/bin/ruby-build exited with non-zero status: exit code 1\n\nLocation:\n   src/cmd.rs:479\n\nVersion:\n   2025.4.11 linux-x64 (2025-04-27)\n\nBacktrace omitted. Run with RUST_BACKTRACE=1 environment variable to display it.\nRun with RUST_BACKTRACE=full to include source snippets.\n```\n\n## 最適化をやめる\n\n13.3.0 は最適化をやめることでコンパイル成功。\n\n```shell\n$ export CFLAGS=\"-O0\"\n  export CPPFLAGS=\"-O0\"\n  export CXXFLAGS=\"-O0\"\n  export LDFLAGS=\"\"\n$ MISE_JOBS=28 mise install ruby 3.4.4\n$ ruby -v\nruby 3.4.4 (2025-05-14 revision a38531fd3f) +PRISM [x86_64-linux]\n```\n\n## 14.2.0 なら普通にコンパイル成功する\n\ngcc 13.x から 14.x にアップグレード\n\n```shell\nsudo add-apt-repository ppa:ubuntu-toolchain-r/test\nsudo apt update\nsudo apt install gcc-14 g++-14\nsudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 100\nsudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-14 100\nsudo update-alternatives --config gcc\nsudo update-alternatives --config g++\n```\n\n```shell\n$ gcc --version\ngcc (Ubuntu 14.2.0-4ubuntu2~24.04) 14.2.0\n$ mise uninstall ruby 3.4.4\n$ MISE_JOBS=28 mise install ruby 3.4.4\n$ ruby -v\nruby 3.4.4 (2025-05-14 revision a38531fd3f) +PRISM [x86_64-linux]\n```\n",
      "body_updated_at": "2025-05-24"
    }
  ]
}