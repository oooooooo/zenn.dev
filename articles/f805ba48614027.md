---
title: "ã‚µãƒ¼ãƒå†èµ·å‹•ã—ã¦ã‚‚ cron ã§ Web ã‚¢ãƒ—ãƒªã‚’é›‘ã«ç«‹ã¡ä¸Šã’"
emoji: "ğŸ•‘"
type: "tech"
topics:
  - "cron"
  - "crontab"
published: true
published_at: "2024-03-09 17:13"
---

[è¶…æ¥½ã«Rubyã§é›‘ã«æ›¸ã„ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’systemdã§ç®¡ç†ã—ãŸã„ï¼ - å®‡å®™è¡ŒããŸã„](https://yoshiori.hatenablog.com/entry/2024/03/07/224424) ã§ systemd ãŒãƒ¦ãƒ¼ã‚¶æ¨©é™ã§ä½¿ãˆã‚‹ã“ã¨ã‚’çŸ¥ã‚‹ã€‚

é–‹ç™ºç’°å¢ƒç”¨ã§ã¯ nohup ã¨ cron ã® @reboot ã‚’ä½¿ã£ã¦ã„ã¾ã—ãŸã€‚ã“ã¡ã‚‰ã‚‚ãŠæ‰‹è»½ãªã®ã§ç´¹ä»‹ã€‚

## @reboot ã¨ã¯

crontab(5) ã« @reboot ãŒã‚ã‚Œã°ä½¿ãˆã¾ã™ã€‚ãã®åã®é€šã‚Šãƒªãƒ–ãƒ¼ãƒˆæ™‚ã«ä¸€å›ã ã‘å®Ÿè¡Œã€‚Ubuntu ãªã‚‰åˆ©ç”¨å¯èƒ½ã€‚

```shell
$ man 5 crontab
(çœç•¥)
       Instead of the first five fields, one of eight special strings may appear:

              string         meaning
              ------         -------
              @reboot        Run once, at startup.
              @yearly        Run once a year, "0 0 1 1 *".
              @annually      (same as @yearly)
              @monthly       Run once a month, "0 0 1 * *".
              @weekly        Run once a week, "0 0 * * 0".
              @daily         Run once a day, "0 0 * * *".
              @midnight      (same as @daily)
              @hourly        Run once an hour, "0 * * * *".
```

## crontab ã®æ›¸ãæ–¹

```shell
$ crontab -e
@reboot /home/oooooooo/work/cron-reboot.sh > /tmp/cron-reboot.log 2>&1
```

## cron-reboot.sh ã®ä¸­èº«

Sinatra ã‚„ Railsã€Chalice ãªã©ã®é›‘ãªã‚¢ãƒ—ãƒªãŒåæ•°å€‹ä¸¦ã³ã¾ã™ã€‚Ruby ã‚„ Python ã‚’ä½¿ã£ã¦ã„ã‚‹ãŸã‚ asdf ã§ç®¡ç†ã€‚

ã‚¢ãƒ—ãƒªãŒè¿½åŠ ã•ã‚ŒãŸã‚‰ã“ã® cron-reboot.sh ã«è¿½åŠ ã™ã‚‹ã ã‘ã€‚

```shell:cron-reboot.sh
#!/usr/bin/bash
# @reboot /home/oooooooo/work/cron-reboot.sh > /tmp/cron-reboot.log 2>&1

set -ex

# API ã‚­ãƒ¼ãªã©ã®ç’°å¢ƒå¤‰æ•°
source "/home/oooooooo/.secret"
source "/home/oooooooo/.asdf/asdf.sh"

cd "/home/oooooooo/work/some-sinatara-pp" || exit
./run.sh

cd "/home/oooooooo/work/some-rails-app" || exit
./run.sh

cd "/home/oooooooo/work/some-chalice-app" || exit
./run.sh
```

## nohup ã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œ

ãã‚Œãã‚Œã® run.sh ã®ä¸­èº«ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚nohup ãŒã‚ã‚‹ã®ã¯ ssh ã—ã¦èµ·å‹•ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€‚

```shell
nohup ruby app.rb &
```
```shell
nohup rails server -p 3008 -b 0.0.0.0 &
```
```shell
nohup chalice local --port 3013 --host 0.0.0.0 &
```

ã“ã‚Œã§ apt upgrade ã® OS ãƒªãƒ–ãƒ¼ãƒˆã‚‚æ°—è»½ã«è¡Œãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚