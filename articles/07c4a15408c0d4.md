---
title: "git-secrets で Twilio が不正利用されるのを防ぐ"
emoji: "👻"
type: "tech"
topics: []
published: false
---

不正利用の主な原因はソースコードからのクレデンシャル情報流出です。

[Twilio は GitHub にクレデンシャルが流出していないかチェックし、メールで連絡](https://www.twilio.com/blog/protect-against-accidental-credential-leaks-twilio-git-guard)していますが、クレデンシャル情報の削除まで利用される可能性があります。そのため流出させないことが重要です。

[git-secrets](https://github.com/awslabs/git-secrets) は commit 時に特定の文字列を探し、マッチしたら commit を中止します。これによりクレデンシャル流出が防げます。

```bash
$ git commit -am 'Release 1.0.0'
app.rb:5:TWILIO_API_SECRET = 'ab012345678901234567890123456789'

[ERROR] Matched one or more prohibited patterns
```

導入の流れは下記。

1. .env の利用
1. .env を .gitignore に追加
1. API Key の利用
1. git-secrets をインストールし、ダミーの API Key's Secret (例えば ab012345678901234567890123456789 ) が commit できないか試す

## 環境変数を使う

ソースコードにクレデンシャルを書かないためには環境変数を利用することです。
各種言語での環境変数を使う方法と可愛い子犬は [How to Set Environmental Variables | Twilio](https://www.twilio.com/blog/2017/01/how-to-set-environment-variables.html) で。

環境変数を書いた .env を .gitignore に追加し、リポジトリからクレデンシャル情報が含まれないようにします。

## API Key を使う

クレデンシャルは Auth Token ではなく API Key をお勧めします。開発環境と本番環境で分けたり、開発者個々人に用意できるためです。

各種言語での API Key の作り方と使い方は [API Key Resource | Twilio](https://www.twilio.com/docs/iam/keys/api-key) で。

```ruby
require 'twilio-ruby'

# [非推奨] Auth Token を使う場合
account_sid = ENV['TWILIO_ACCOUNT_SID']
auth_token = ENV['TWILIO_AUTH_TOKEN']
@client = Twilio::REST::Client.new(account_sid, auth_token)

# [推奨] API Key を使い場合
account_sid = ENV['TWILIO_ACCOUNT_SID']
api_key = ENV['TWILIO_API_KEY']
api_secret = ENV['TWILIO_API_SECRET']
@client = Twilio::REST::Client.new(api_key, api_secret, account_sid)
```

## git-secrets の使い方

s なしの [git-secret](https://git-secret.io/) もあるのですが、s ありの [git-secrets](https://github.com/awslabs/git-secrets) がいろいろと便利です。

### インストール

```bash
# UNIX
git clone git@github.com:awslabs/git-secrets.git
cd git-secrets
sudo make install
# Mac
brew install git-secrets
```

### 初期設定

Twilio のクレデンシャルである Auth Token や API Key's Secret のパターン ```[0-9a-zA-Z]{32}``` を登録します。設定内容は .git/config にあります。

```bash
$ cd プロジェクトのリポジトリ
$ git secrets --install
$ git secrets --add '[0-9a-zA-Z]{32}'
$ grep -A1 secrets .git/config
[secrets]
        patterns = [0-9a-zA-Z]{32}
```

これで初期設定は完了です。試しにクレデンシャルを書いて commit してみます。

```bash
$ cat test.rb
TWILIO_API_SECRET = 'ab012345678901234567890123456789'
$ git add test.rb
$ git commit -m 'test'
test.rb:1:TWILIO_API_SECRET = 'ab012345678901234567890123456789'

[ERROR] Matched one or more prohibited patterns
```

禁止されたパターンが見つかり commit できませんでした。

今度は環境変数を使ってみます。こちらは問題なく commit できます。

```bash
$ cat test.rb
TWILIO_API_SECRET = ENV['TWILIO_API_SECRET']
$ git commit -m 'test'
```

### 便利な使い方

commit 前に確認。

```bash
git secrets --scan
```

過去の commit を調べる。

```bash
git secrets --scan-history
```

不幸にも見つかったら [BFG を使って過去の commit を削除](https://docs.github.com/ja/authentication/keeping-your-account-and-data-secure/removing-sensitive-data-from-a-repository) しましょう。

もし AWS を使っていたら下記で簡単に AWS のパターンが登録できます。

```bash
$ git secrets --register-aws 
```

このような感じで登録されます。

```bash
$ grep -A10 secrets .git/config
[secrets]
        patterns = [0-9a-zA-Z]{32}
        providers = git secrets --aws-provider
        patterns = (A3T[A-Z0-9]|AKIA|AGPA|AIDA|AROA|AIPA|ANPA|ANVA|ASIA)[A-Z0-9]{16}
        patterns = (\"|')?(AWS|aws|Aws)?_?(SECRET|secret|Secret)?_?(ACCESS|access|Access)?_?(KEY|key|Key)(\"|')?\\s*(:|=>|=)\\s*(\"|')?[A-Za-z0-9/\\+=]{40}(\"|')?
        patterns = (\"|')?(AWS|aws|Aws)?_?(ACCOUNT|account|Account)_?(ID|id|Id)?(\"|')?\\s*(:|=>|=)\\s*(\"|')?[0-9]{4}\\-?[0-9]{4}\\-?[0-9]{4}(\"|')?
        allowed = AKIAIOSFODNN7EXAMPLE
        allowed = wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
```

もし誤検知する場合は allowed に追加すれば commit が通ります。

## その他のセキュリティ対策

- 開発メンバーの変更時は API Key の変更
- もし Laravel ならデバッグモード (APP_DEBUG) を false に。true だと例外エラー時に変数を画面に出力するためクレデンシャルが漏洩します



